generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(uuid())
  clerkId           String   @unique
  email             String   @unique
  name              String?
  firstName         String?
  lastName          String?

  // B2B Pflichtfelder
  company           String?  // Company name
  companyName       String?  // Alternative field name
  vatId             String?  // USt-IdNr.
  companyStreet     String?
  companyZip        String?
  companyCity       String?
  companyCountry    String?  @default("DE")

  // B2B Best채tigung
  isBusinessCustomer Boolean  @default(false)
  acceptedB2BTermsAt DateTime?

  role              UserRole @default(BUYER)
  walletBalance     Decimal  @default(0) @db.Decimal(10, 2)
  iban              String?
  bankAccountHolder String?
  referralCode      String?  @unique
  referredBy        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // CRM-Felder
  customerStatus    String?  @default("active") // active, pending, inactive, vip
  totalSpent        Decimal? @default(0) @db.Decimal(10, 2)
  lastOrderAt       DateTime?

  orders             Order[]
  commissionsEarned  Commission[]       @relation("ResellerCommissions")
  walletTransactions WalletTransaction[]
  payoutRequests     PayoutRequest[]
  commissionContracts CommissionContract[]
  customerNotes      CustomerNote[]
  customerActivities CustomerActivity[]
  affiliateLinks     AffiliateLink[]    @relation("UserAffiliateLinks")
  affiliateWithdrawals AffiliateWithdrawal[] @relation("UserAffiliateWithdrawals")
  chatRooms          ChatRoom[]         @relation("UserChatRooms")

  @@map("users")
}

enum UserRole {
  BUYER
  RESELLER
  ADMIN
}

model Product {
  id           String        @id @default(uuid())
  name         String
  description  String?
  price        Decimal       @db.Decimal(10, 2)
  retailValue  Decimal       @db.Decimal(10, 2)
  stock        Int           @default(0)
  palletCount  Int           @default(1)
  status       ProductStatus @default(AVAILABLE)
  images       String[]      @default([])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  orderItems OrderItem[]

  @@map("products")
}

enum ProductStatus {
  AVAILABLE
  RESERVED
  SOLD
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  stripePaymentId String?
  paidAt          DateTime?
  pickedUpAt      DateTime?
  fulfillmentType String?     // "delivery" oder "commission"
  invoiceNumber   String?     @unique
  invoiceSentAt   DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user              User                @relation(fields: [userId], references: [id])
  items             OrderItem[]
  commission        Commission?
  storageFees       StorageFee[]
  commissionContract CommissionContract?
  deliveryAddress   DeliveryAddress?
  affiliateConversion AffiliateConversion?

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Commission {
  id         String           @id @default(uuid())
  orderId    String           @unique
  resellerId String
  amount     Decimal          @db.Decimal(10, 2)
  status     CommissionStatus @default(PENDING)
  paidAt     DateTime?
  createdAt  DateTime         @default(now())

  order    Order @relation(fields: [orderId], references: [id])
  reseller User  @relation("ResellerCommissions", fields: [resellerId], references: [id])

  @@map("commissions")
}

enum CommissionStatus {
  PENDING
  PAID
}

model StorageFee {
  id           String    @id @default(uuid())
  orderId      String
  amount       Decimal   @db.Decimal(10, 2)
  palletCount  Int
  daysCharged  Int
  calculatedAt DateTime  @default(now())
  paidAt       DateTime?
  createdAt    DateTime  @default(now())

  order Order @relation(fields: [orderId], references: [id])

  @@map("storage_fees")
}

model WalletTransaction {
  id          String            @id @default(uuid())
  userId      String
  type        TransactionType
  amount      Decimal           @db.Decimal(10, 2)
  description String?
  reference   String?
  status      TransactionStatus @default(COMPLETED)
  createdAt   DateTime          @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("wallet_transactions")
}

enum TransactionType {
  COMMISSION_EARNED
  PAYOUT_REQUESTED
  PAYOUT_COMPLETED
  STORAGE_FEE_CHARGED
  REFUND
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model PayoutRequest {
  id          String       @id @default(uuid())
  userId      String
  amount      Decimal      @db.Decimal(10, 2)
  iban        String
  bankName    String?
  status      PayoutStatus @default(PENDING)
  processedAt DateTime?
  processedBy String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("payout_requests")
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model CommissionContract {
  id              String   @id @default(uuid())

  // Beziehungen
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id])
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // Vertragsdaten
  contractNumber  String   @unique
  productName     String
  productQuantity Int
  purchasePrice   Decimal  @db.Decimal(10, 2)
  commissionRate  Decimal  @default(0.20) @db.Decimal(5, 2)

  // PDF & Signatur
  contractPdfUrl  String?
  signedPdfUrl    String?
  signatureData   String?  @db.Text
  signedAt        DateTime?

  // Bankdaten f체r Auszahlung
  iban            String?
  bic             String?
  accountHolder   String?

  // Status
  status          String   @default("draft") // draft, pending_signature, signed, active, completed, cancelled

  // Verkaufsstatus (f체r Commercehelden Admin)
  salesStatus     String   @default("pending") // pending, listed, sold
  salesPrice      Decimal? @db.Decimal(10, 2)
  soldAt          DateTime?

  // Auszahlung
  payoutAmount    Decimal? @db.Decimal(10, 2)
  payoutStatus    String   @default("pending") // pending, processing, completed
  paidAt          DateTime?

  // Lagerung
  storageStartDate DateTime @default(now())
  storageFeePerDay Decimal  @default(0.50) @db.Decimal(10, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("commission_contracts")
}

model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hash
  name      String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

model DeliveryAddress {
  id        String   @id @default(uuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  street    String
  zipCode   String
  city      String
  country   String   @default("AT")
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("delivery_addresses")
}

model CustomerNote {
  id        String   @id @default(uuid())
  userId    String
  authorId  String   // Admin der die Notiz erstellt hat
  content   String   @db.Text
  noteType  String   @default("general") // general, call, meeting, issue
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("customer_notes")
}

model CustomerActivity {
  id        String   @id @default(uuid())
  userId    String
  action    String   // order_placed, contract_signed, payout_requested, login, etc.
  details   Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("customer_activities")
}

model AffiliateLink {
  id          String                @id @default(uuid())
  userId      String
  user        User                  @relation("UserAffiliateLinks", fields: [userId], references: [id])
  code        String                @unique // z.B. "A7xK9m" - 6 Zeichen alphanumerisch
  clicks      AffiliateClick[]
  conversions AffiliateConversion[]
  createdAt   DateTime              @default(now())

  @@map("affiliate_links")
}

model AffiliateClick {
  id        String        @id @default(uuid())
  linkId    String
  link      AffiliateLink @relation(fields: [linkId], references: [id])
  ipHash    String        // gehashte IP f체r Datenschutz
  createdAt DateTime      @default(now())

  @@map("affiliate_clicks")
}

model AffiliateConversion {
  id        String        @id @default(uuid())
  linkId    String
  link      AffiliateLink @relation(fields: [linkId], references: [id])
  orderId   String        @unique
  order     Order         @relation(fields: [orderId], references: [id])
  amount    Decimal       @db.Decimal(10, 2) // 5% vom Bestellwert
  status    String        @default("PENDING") // PENDING, APPROVED, PAID
  createdAt DateTime      @default(now())

  @@map("affiliate_conversions")
}

model AffiliateWithdrawal {
  id             String                    @id @default(uuid())
  userId         String
  user           User                      @relation("UserAffiliateWithdrawals", fields: [userId], references: [id])
  amount         Decimal                   @db.Decimal(10, 2)
  method         AffiliatePaymentMethod    @default(BANK)

  // Bank transfer fields
  iban           String?
  accountHolder  String?

  // PayPal fields
  paypalEmail    String?

  status         AffiliateWithdrawalStatus @default(PENDING)

  // Admin processing
  processedAt    DateTime?
  processedBy    String?
  notes          String?                   @db.Text

  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  @@map("affiliate_withdrawals")
}

enum AffiliatePaymentMethod {
  BANK
  PAYPAL
}

enum AffiliateWithdrawalStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

model ChatRoom {
  id          String         @id @default(uuid())
  userId      String
  user        User           @relation("UserChatRooms", fields: [userId], references: [id])
  userEmail   String
  userName    String
  subject     String
  status      ChatRoomStatus @default(OPEN)
  roomType    ChatRoomType   @default(SUPPORT)
  initiatedBy String         @default("USER") // "USER" oder "ADMIN"
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  messages ChatMessage[]

  @@map("chat_rooms")
}

model ChatMessage {
  id         String           @id @default(uuid())
  roomId     String
  room       ChatRoom         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  senderType ChatSenderType
  senderName String
  message    String           @db.Text
  read       Boolean          @default(false)
  createdAt  DateTime         @default(now())

  @@map("chat_messages")
}

enum ChatRoomStatus {
  OPEN
  CLOSED
}

enum ChatRoomType {
  SUPPORT   // Normaler Kundensupport
  AFFILIATE // Affiliate-bezogener Chat
  ORDER     // Bestellbezogener Chat
}

enum ChatSenderType {
  USER
  ADMIN
}
