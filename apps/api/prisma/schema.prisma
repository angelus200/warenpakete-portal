generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(uuid())
  clerkId           String   @unique
  email             String   @unique
  name              String?
  firstName         String?
  lastName          String?

  // B2B Pflichtfelder
  company           String?  // Company name
  companyName       String?  // Alternative field name
  vatId             String?  // USt-IdNr.
  companyStreet     String?
  companyZip        String?
  companyCity       String?
  companyCountry    String?  @default("DE")

  // B2B Bestätigung
  isBusinessCustomer Boolean  @default(false)
  acceptedB2BTermsAt DateTime?

  role              UserRole @default(BUYER)
  walletBalance     Decimal  @default(0) @db.Decimal(10, 2)
  iban              String?
  bankAccountHolder String?
  referralCode      String?  @unique
  referredBy        String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  orders             Order[]
  commissionsEarned  Commission[]       @relation("ResellerCommissions")
  walletTransactions WalletTransaction[]
  payoutRequests     PayoutRequest[]
  commissionContracts CommissionContract[]

  @@map("users")
}

enum UserRole {
  BUYER
  RESELLER
  ADMIN
}

model Product {
  id           String        @id @default(uuid())
  name         String
  description  String?
  price        Decimal       @db.Decimal(10, 2)
  retailValue  Decimal       @db.Decimal(10, 2)
  stock        Int           @default(0)
  palletCount  Int           @default(1)
  status       ProductStatus @default(AVAILABLE)
  images       String[]      @default([])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  orderItems OrderItem[]

  @@map("products")
}

enum ProductStatus {
  AVAILABLE
  RESERVED
  SOLD
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  stripePaymentId String?
  paidAt          DateTime?
  pickedUpAt      DateTime?
  fulfillmentType String?     // "delivery" oder "commission"
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user              User                @relation(fields: [userId], references: [id])
  items             OrderItem[]
  commission        Commission?
  storageFees       StorageFee[]
  commissionContract CommissionContract?
  deliveryAddress   DeliveryAddress?

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Commission {
  id         String           @id @default(uuid())
  orderId    String           @unique
  resellerId String
  amount     Decimal          @db.Decimal(10, 2)
  status     CommissionStatus @default(PENDING)
  paidAt     DateTime?
  createdAt  DateTime         @default(now())

  order    Order @relation(fields: [orderId], references: [id])
  reseller User  @relation("ResellerCommissions", fields: [resellerId], references: [id])

  @@map("commissions")
}

enum CommissionStatus {
  PENDING
  PAID
}

model StorageFee {
  id           String    @id @default(uuid())
  orderId      String
  amount       Decimal   @db.Decimal(10, 2)
  palletCount  Int
  daysCharged  Int
  calculatedAt DateTime  @default(now())
  paidAt       DateTime?
  createdAt    DateTime  @default(now())

  order Order @relation(fields: [orderId], references: [id])

  @@map("storage_fees")
}

model WalletTransaction {
  id          String            @id @default(uuid())
  userId      String
  type        TransactionType
  amount      Decimal           @db.Decimal(10, 2)
  description String?
  reference   String?
  status      TransactionStatus @default(COMPLETED)
  createdAt   DateTime          @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("wallet_transactions")
}

enum TransactionType {
  COMMISSION_EARNED
  PAYOUT_REQUESTED
  PAYOUT_COMPLETED
  STORAGE_FEE_CHARGED
  REFUND
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

model PayoutRequest {
  id          String       @id @default(uuid())
  userId      String
  amount      Decimal      @db.Decimal(10, 2)
  iban        String
  bankName    String?
  status      PayoutStatus @default(PENDING)
  processedAt DateTime?
  processedBy String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("payout_requests")
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

model CommissionContract {
  id              String   @id @default(uuid())

  // Beziehungen
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id])
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  // Vertragsdaten
  contractNumber  String   @unique
  productName     String
  productQuantity Int
  purchasePrice   Decimal  @db.Decimal(10, 2)
  commissionRate  Decimal  @default(0.20) @db.Decimal(5, 2)

  // PDF & Signatur
  contractPdfUrl  String?
  signedPdfUrl    String?
  signatureData   String?  @db.Text
  signedAt        DateTime?

  // Bankdaten für Auszahlung
  iban            String?
  bic             String?
  accountHolder   String?

  // Status
  status          String   @default("draft") // draft, pending_signature, signed, active, completed, cancelled

  // Verkaufsstatus (für Commercehelden Admin)
  salesStatus     String   @default("pending") // pending, listed, sold
  salesPrice      Decimal? @db.Decimal(10, 2)
  soldAt          DateTime?

  // Auszahlung
  payoutAmount    Decimal? @db.Decimal(10, 2)
  payoutStatus    String   @default("pending") // pending, processing, completed
  paidAt          DateTime?

  // Lagerung
  storageStartDate DateTime @default(now())
  storageFeePerDay Decimal  @default(0.50) @db.Decimal(10, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("commission_contracts")
}

model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hash
  name      String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

model DeliveryAddress {
  id        String   @id @default(uuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  street    String
  zipCode   String
  city      String
  country   String   @default("AT")
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("delivery_addresses")
}
