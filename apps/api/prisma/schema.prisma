generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique
  email         String   @unique
  name          String?
  firstName     String?
  lastName      String?
  company       String?
  vatId         String?
  role          UserRole @default(BUYER)
  walletBalance Decimal  @default(0) @db.Decimal(10, 2)
  referralCode  String?  @unique
  referredBy    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orders            Order[]
  commissionsEarned Commission[] @relation("ResellerCommissions")

  @@map("users")
}

enum UserRole {
  BUYER
  RESELLER
  ADMIN
}

model Product {
  id           String        @id @default(uuid())
  name         String
  description  String?
  price        Decimal       @db.Decimal(10, 2)
  retailValue  Decimal       @db.Decimal(10, 2)
  stock        Int           @default(0)
  palletCount  Int           @default(1)
  status       ProductStatus @default(AVAILABLE)
  images       String[]      @default([])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  orderItems OrderItem[]

  @@map("products")
}

enum ProductStatus {
  AVAILABLE
  RESERVED
  SOLD
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  stripePaymentId String?
  paidAt          DateTime?
  pickedUpAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user        User         @relation(fields: [userId], references: [id])
  items       OrderItem[]
  commission  Commission?
  storageFees StorageFee[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Commission {
  id         String           @id @default(uuid())
  orderId    String           @unique
  resellerId String
  amount     Decimal          @db.Decimal(10, 2)
  status     CommissionStatus @default(PENDING)
  paidAt     DateTime?
  createdAt  DateTime         @default(now())

  order    Order @relation(fields: [orderId], references: [id])
  reseller User  @relation("ResellerCommissions", fields: [resellerId], references: [id])

  @@map("commissions")
}

enum CommissionStatus {
  PENDING
  PAID
}

model StorageFee {
  id           String    @id @default(uuid())
  orderId      String
  amount       Decimal   @db.Decimal(10, 2)
  palletCount  Int
  daysCharged  Int
  calculatedAt DateTime  @default(now())
  paidAt       DateTime?
  createdAt    DateTime  @default(now())

  order Order @relation(fields: [orderId], references: [id])

  @@map("storage_fees")
}
